<link rel="import" href="feed-items.html">
<link rel="import" href="brain-image.html">
<link rel="import" href="sign-up.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/wired-button/wired-button.html">

<dom-module id="fake-news-app">
  <template>
    <style>
      :host {
        display: block;
      }

      .container {
        display: flex;
        justify-content: space-between;
      }

      .container > * {
        margin: 10px;
      }

      #app {
        visibility: hidden;
      }

      .modal-button {
        display: flex;
        justify-content: space-around;
      }

      wired-button {
        background-color: pink;        
      }
      
    </style>
    <sign-up id="signup"></sign-up>

    <div id="app" class="container">
  	  <feed-items id="items"></feed-items>
      <brain-image id="brain" user="[[user]]"></brain-image>
    </div>

    <paper-dialog id="welcome" modal>
      <marked-element>
        <div slot="markdown-html"></div>
        <script type="text/markdown" src="markdown/welcome.md"></script>
      </marked-element>
      <div class="modal-button">
        <wired-button dialog-confirm autofocus text="Get started!"></wired-button>
      </div>
    </paper-dialog>


	</template>

  </template>

  <script>
    /**
     * `fake-news-app`

     */
    class FakeNewsApp extends Polymer.Element {
      static get is() { return 'fake-news-app'; }
      static get properties() {
        return {
          user: {
          	type: Object,
            value: {
              name: 'Ellen',
              gender: 'F',
              age: 23
            }
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();

        this.addEventListener('signup', this._handleSignup.bind(this));
        this.$.app.addEventListener('action', this._handleAction.bind(this));
        this.$.welcome.open();
      }

      _handleAction (event) {
          let likelihoodIncrease = event.detail.likelihoodIncrease;
          let likelihoodDecrease = event.detail.likelihoodIncrease / (this.user.likelihoods.length - 1);
          let category = event.detail.category;

          this.user.likelihoods = this.user.likelihoods.map(function(item) {
            if (item.name === category) {
              if (item.y + likelihoodIncrease < 100) {
                return {name: item.name, y: item.y + likelihoodIncrease};
              } else {
                return {name: item.name, y: 100};
              }
            } else {
              if (item.y - likelihoodDecrease > 0) {
                return {name: item.name, y: item.y - likelihoodDecrease};
              } else {
                return {name: item.name, y: 0};
              }
            }
          });

          this.$.brain.updateUser(this.user);
          this.$.items.updateItems(this.user.likelihoods);
      }

      _handleSignup (event) {
          this.user = event.detail.user;
          this.user.likelihoods = [{name: 'Liberal', y: 30}, {name: 'Conservative', y: 30}, {name: 'Animals', y: 40}];
          this.$.app.style.visibility = 'visible';
          this.$.signup.style.display = 'none';
          this.$.items.updateItems(this.user.likelihoods);
      }

    }

    window.customElements.define(FakeNewsApp.is, FakeNewsApp);
  </script>
</dom-module>

